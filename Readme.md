# æ‰“é€šä¸‰ç•Œï¼šCocos C++ å…¨å¹³å°å¼€å‘çš„æœ€åä¸€å…¬é‡Œå®è·µ

### ğŸ”¥ æœ¬æ–‡äº®ç‚¹

1. **è·¨å¹³å°ä¸€è‡´æ€§** - ä¸€å¥—C++ä»£ç ï¼Œåœ¨Androidã€iOSã€Webã€å¾®ä¿¡å°æ¸¸æˆç­‰å¹³å°ä¸Šå®Œç¾è¿è¡Œã€‚
2. **æ— ç¼å‡çº§å¼•æ“** - æ— éœ€ä¿®æ”¹å¼•æ“ä»£ç ï¼Œå³å¯æ— ç¼å‡çº§Cocos Creatorç‰ˆæœ¬ã€‚
3. **å¿«é€Ÿé›†æˆ** - å®Œç¾èå…¥Cocos Creatorçš„å·¥ä½œæµï¼Œä¸ç°æœ‰é¡¹ç›®æ— ç¼é›†æˆã€‚æ— éœ€å¤æ‚çš„å¼•æ“é…ç½®,åªéœ€è¦å°†ä½ çš„ä»£ç æ”¾åˆ°å¯¹åº”çš„æ–‡ä»¶å¤¹,ç›´æ¥æ„å»ºè„šæœ¬å³å¯ã€‚

## å‰è¨€ï¼šC++å…¨å¹³å°çš„æ¢¦æƒ³ï¼Œç»ˆäºç…§è¿›ç°å®

### é‚£äº›å¹´ï¼Œæˆ‘ä»¬é”™è¿‡çš„C++ä¸–ç•Œ

è¿˜è®°å¾—é‚£äº›å¹´å—ï¼Ÿå½“æˆ‘ä»¬çœ‹åˆ°Unityå¼€å‘è€…å¯ä»¥è½»æ¾è°ƒç”¨C++åº“ï¼Œå½“æˆ‘ä»¬ç¾¡æ…•Unreal Engineçš„å¼ºå¤§æ€§èƒ½ï¼Œå½“æˆ‘ä»¬æ¸´æœ›åœ¨Cocos Creatorä¸­ä½¿ç”¨é‚£äº›ä»¤äººå‚æ¶çš„C++æ‰©å±•åº“æ—¶ï¼Œå†…å¿ƒæ€»æ˜¯å……æ»¡äº†æ— å¥ˆã€‚

**OpenCV**çš„å›¾åƒå¤„ç†èƒ½åŠ›ï¼Œ**FFmpeg**çš„éŸ³è§†é¢‘å¤„ç†ï¼Œ**TensorFlow**çš„æœºå™¨å­¦ä¹ ï¼Œ**SQLite**çš„æ•°æ®åº“æ“ä½œï¼Œ**zlib**çš„å‹ç¼©ç®—æ³•... è¿™äº›åœ¨C++ä¸–ç•Œä¸­é—ªé—ªå‘å…‰çš„åº“ï¼Œæ›¾ç»ç¦»æˆ‘ä»¬é‚£ä¹ˆè¿‘ï¼Œå´åˆé‚£ä¹ˆè¿œã€‚

æˆ‘ä»¬åªèƒ½çœ¼å·´å·´åœ°çœ‹ç€ï¼Œçœ‹ç€é‚£äº›å¼ºå¤§çš„åŠŸèƒ½åœ¨åŸç”Ÿåº”ç”¨ä¸­å¤§æ”¾å¼‚å½©ï¼Œè€Œæˆ‘ä»¬çš„Webæ¸¸æˆå´åªèƒ½ä½¿ç”¨JavaScriptçš„"é˜‰å‰²ç‰ˆ"å®ç°ã€‚æ€§èƒ½çš„å·®è·ï¼ŒåŠŸèƒ½çš„ç¼ºå¤±ï¼Œè®©æˆ‘ä»¬åœ¨ç«äº‰ä¸­å¤„äºåŠ£åŠ¿ã€‚

### WebAssemblyï¼šæ”¹å˜ä¸€åˆ‡çš„æŠ€æœ¯é©å‘½

ä½†æ˜¯ï¼Œ**WebAssemblyï¼ˆWASMï¼‰**çš„å‡ºç°ï¼Œå½»åº•æ”¹å˜äº†è¿™ä¸€åˆ‡ï¼

è¿™ä¸ªçœ‹ä¼¼ç®€å•çš„æŠ€æœ¯ï¼Œå´è•´å«ç€å·¨å¤§çš„èƒ½é‡ã€‚å®ƒè®©C++ä»£ç èƒ½å¤Ÿåœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼Œæ€§èƒ½æ¥è¿‘åŸç”Ÿï¼Œè®©é‚£äº›æ›¾ç»åªèƒ½åœ¨æ¡Œé¢å’Œç§»åŠ¨ç«¯ä½¿ç”¨çš„å¼ºå¤§åº“ï¼Œéšç€è¦†ç›–ç‡çš„æå‡,ç»ˆäºå¯ä»¥åœ¨Webå¹³å°ä¸Šå¤§æ˜¾èº«æ‰‹ã€‚

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ çš„æ¸¸æˆå¯ä»¥åœ¨Webä¸Šä½¿ç”¨OpenCVè¿›è¡Œå®æ—¶å›¾åƒå¤„ç†ï¼Œä½¿ç”¨FFmpegè¿›è¡ŒéŸ³è§†é¢‘ç¼–è§£ç ï¼Œä½¿ç”¨TensorFlowè¿›è¡ŒAIæ¨ç†, è¿™ä¸€åˆ‡ï¼Œéƒ½å› ä¸ºWebAssemblyè€Œæˆä¸ºå¯èƒ½ï¼

çœ‹ä¸€ä¸‹å…¼å®¹æ€§,ç›®å‰åŸºæœ¬ä¸Šå·²ç»å…¨é¢è¦†ç›–äº†

![WebAssembly å…¼å®¹æ€§](doc/wasm-support.png)


### æœ€åä¸€å…¬é‡Œçš„æŒ‘æˆ˜

- ä»…ä»…æœ‰WebAssemblyè¿˜ä¸å¤Ÿã€‚åŒæ ·ä¸€ä»½C++,æ²¡æ³•åŒæ—¶åœ¨Nativeå’ŒWebä¹‹é—´ç›´æ¥ä½¿ç”¨,è¿˜éœ€è¦ä¸“é—¨ä¸ºåŸç”Ÿå’Œwebå•ç‹¬å‡ºä¸€ä»½ç›¸åŒåŠŸèƒ½çš„ç»‘å®šé€»è¾‘
- æ·±å—2.xçš„å½±å“,æ˜¯å¦ä¸€å®šè¦ä¿®æ”¹å¼•æ“æ‰èƒ½æ•´åˆè‡ªå·±çš„åŠŸèƒ½,å¦‚ä½•åœ¨ä¸ä¿®æ”¹å¼•æ“çš„æƒ…å†µä¸‹ï¼Œæ•´åˆè‡ªå·±çš„åŠŸèƒ½
- ç»‘å®šé€»è¾‘çš„å¤æ‚æ€§ï¼Œå¤æ‚çš„ç¯å¢ƒæ•´åˆé…ç½®,å¦‚ä½•ç®€åŒ–è¿™ä¸ªè¿‡ç¨‹
- å¦‚ä½•åœ¨ä¸ä¿®æ”¹å¼•æ“çš„æƒ…å†µä¸‹,ç®¡ç†è‡ªå·±çš„å¼•æ“ä»£ç 
- åœ¨å‡çº§å¼•æ“æ—¶ï¼Œå¦‚ä½•ä¿è¯è‡ªå·±çš„ä»£ç ä¸è¢«ç ´å,å®ç°æ— ç¼æ— è„‘å‡çº§å¼•æ“



æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªæ¡¥æ¢ï¼Œä¸€ä¸ªèƒ½å¤Ÿå°†C++çš„å¼ºå¤§èƒ½åŠ›æ— ç¼é›†æˆåˆ°Cocos Creatorç”Ÿæ€ä¸­çš„æ¡¥æ¢ã€‚

å› æ­¤æœ¬æ–‡å°±å¸¦ä½ ä¸€èµ·æ¢ç´¢å¦‚ä½•æ‰“é€šCocos C++å…¨å¹³å°çš„æœ€åä¸€å…¬é‡Œã€‚



### ğŸš€ è¢«å¿½è§†çš„åŸç”Ÿæ’ä»¶ç³»ç»Ÿ

>Cocos Creator 3.x å¼•å…¥äº†å¼ºå¤§çš„åŸç”Ÿæ’ä»¶ç³»ç»Ÿï¼Œå…è®¸å¼€å‘è€…åœ¨ä¸ä¿®æ”¹å¼•æ“æºç çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡æ ‡å‡†çš„ `cc_plugin.json` é…ç½®æ–‡ä»¶å’Œ CMake æ„å»ºç³»ç»Ÿï¼Œè½»æ¾é›†æˆåŸç”Ÿ C++ ä»£ç ã€‚è¿™ä¸ªç³»ç»Ÿéµå¾ªå®˜æ–¹æ ‡å‡†ï¼Œæ”¯æŒ Androidã€iOSã€Windowsã€macOS ç­‰æ‰€æœ‰åŸç”Ÿå¹³å°ï¼Œé€šè¿‡ `find_package` æœºåˆ¶è‡ªåŠ¨ç®¡ç†ä¾èµ–å’Œé“¾æ¥ã€‚ç„¶è€Œï¼Œç”±äºç¼ºä¹ Web å¹³å°æ”¯æŒå’Œç»Ÿä¸€çš„è·¨å¹³å°ç»‘å®šæ–¹æ¡ˆï¼Œè®¸å¤šå¼€å‘è€…å¾€å¾€å¿½è§†äº†å®ƒçš„å­˜åœ¨ï¼Œæˆ–è€…å› ä¸ºé…ç½®å¤æ‚è€Œæœ›è€Œå´æ­¥ã€‚å®é™…ä¸Šï¼ŒåŸç”Ÿæ’ä»¶ç³»ç»Ÿæ­£æ˜¯æ‰“é€š C++ å…¨å¹³å°çš„å…³é”®åŸºç¡€è®¾æ–½ã€‚

**ä½†æ˜¯è¿˜æ˜¯è¦ç»™è®¾è®¡è¿™ä¸ªåŸç”Ÿæ’ä»¶ç³»ç»Ÿçš„å¤§ä½¬ç‚¹èµ,ä»–å®Œç¾è§£å†³äº†åŸç”Ÿä»£ç è§£è€¦å¼•æ“çš„é—®é¢˜,ä½¿æˆ‘ä»¬å¯ä»¥æ–¹ä¾¿çš„é›†æˆè‡ªå·±çš„ä»£ç ,å¹¶ä¸”ä¸å½±å“å¼•æ“æœ¬èº«çš„å‡çº§ã€‚**


### æ³¨æ„: å®˜æ–¹åŸç”Ÿæ’ä»¶æ˜¯3xçš„,æ‰€ä»¥ä¸æ”¯æŒ2x,æ‰€ä»¥æœ¬æ–‡ç« æ”¯æŒcocos creator 3.6+ç‰ˆæœ¬ã€‚å…·ä½“å¯ä»¥æŸ¥çœ‹[å®˜æ–¹æ–‡æ¡£](https://docs.cocos.com/creator/3.8/manual/zh/advanced-topics/native-plugins/brief.html#%E5%8E%9F%E7%94%9F%E6%8F%92%E4%BB%B6)ã€‚



### ä¾èµ–æŠ€æœ¯

- **WebAssembly**ï¼šè®©C++ä»£ç åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼Œæ€§èƒ½æ¥è¿‘åŸç”Ÿã€‚
- **Cocos Native Plugin**ï¼šCocos Creatorçš„åŸç”Ÿæ’ä»¶ç³»ç»Ÿï¼Œå…è®¸åœ¨é¡¹ç›®ä¸­é›†æˆåŸç”Ÿä»£ç ã€‚
- **PluginPlus.h**ï¼šä¸€å¥—è·¨å¹³å°çš„C++å®å®šä¹‰å’Œèƒ¶æ°´æ–‡ä»¶ï¼Œè®©ä½ çš„ä»£ç å¯ä»¥åœ¨ä¸åŒå¹³å°ä¸Šæ— ç¼è¿è¡Œã€‚æœ¬æ–‡å°†è¦ä»‹ç»çš„è¿™å¥—å·¥å…·çš„æ ¸å¿ƒå°±æ˜¯è¿™ä¸ªèƒ¶æ°´å±‚ã€‚




### ğŸš€ æ‰“é€šC++å…¨å¹³å°çš„å®è·µ

### 1. è·¨å¹³å°æ¶æ„æ·±åº¦è§£æ

#### æ•´ä½“æ¶æ„å›¾
```mermaid
graph TB
    subgraph "Cocos Creator å¼•æ“å±‚"
        A[TypeScript/JavaScript æ¸¸æˆä»£ç ]
        B[Cocos å¼•æ“è¿è¡Œæ—¶]
        C[æ’ä»¶å‘ç°æœºåˆ¶<br/>cc_plugin.json]
    end

    subgraph "å¹³å°ç»‘å®šå±‚"
        subgraph "åŸç”Ÿå¹³å° Android/iOS"
            D1[Cocos sebind ç³»ç»Ÿ]
            D2[CMake find_package]
            D3[åŸç”Ÿåº“ .so/.a]
        end
        
        subgraph "Web å¹³å°"
            E1[Emscripten ç»‘å®š]
            E2[WASM æ¨¡å—åŠ è½½]
            E3[libCC_PLUGIN_TP__.js]
        end

        subgraph "å¾®ä¿¡å°æ¸¸æˆ"
            F1[Emscripten ç»‘å®š]
            F2[å¾®ä¿¡ WASM é€‚é…]
            F3[CC_PLUGIN_TP__.wasm]
        end
    end

    subgraph "æ’ä»¶èƒ¶æ°´å±‚ (Glue Layer)"
        G[COCOS_CC_PLUGIN_TP__ ç±»<br/>glue/CC_PLUGIN_TP___glue.cpp]
        H[PluginPlus.h å¹³å°æŠ½è±¡]
        I[ç±»å‹è½¬æ¢ä¸ç»‘å®š]
    end

    subgraph "æ’ä»¶æ ¸å¿ƒå±‚ (ç»Ÿä¸€ C++ ä»£ç )"
        J[CC_PLUGIN_TP__ æ ¸å¿ƒç±»<br/>src/CC_PLUGIN_TP__.cpp]
        K[ä¸šåŠ¡é€»è¾‘å®ç°]
        L[ç¬¬ä¸‰æ–¹åº“è°ƒç”¨<br/>THREE_LIB_TP__<br/>simplelog]
    end

    A --> B
    B --> C
    C --> D1
    C --> E1
    C --> F1
    
    D1 --> D2
    D2 --> D3
    D3 --> G
    
    E1 --> E2
    E2 --> E3
    E3 --> G
    
    F1 --> F2
    F2 --> F3
    F3 --> G
    
    G --> H
    H --> I
    I --> J
    J --> K
    K --> L
    
 
```

è¯¥æ¶æ„å›¾å±•ç¤ºäº† Cocos Creator å¼•æ“å¦‚ä½•é€šè¿‡ä¸åŒå¹³å°çš„ç»‘å®šæœºåˆ¶è°ƒç”¨ç»Ÿä¸€çš„ C++ æ’ä»¶ä»£ç ã€‚æ¸¸æˆä»£ç é€šè¿‡å¼•æ“è¿è¡Œæ—¶å’Œæ’ä»¶å‘ç°æœºåˆ¶ï¼ˆ`cc_plugin.json`ï¼‰å®šä½æ’ä»¶ï¼Œç„¶åæ ¹æ®å¹³å°é€‰æ‹©å¯¹åº”çš„ç»‘å®šæ–¹å¼ï¼šåŸç”Ÿå¹³å°ä½¿ç”¨ Cocos çš„ sebind ç³»ç»Ÿå’Œ CMake æ„å»ºï¼ŒWeb å¹³å°é€šè¿‡ Emscripten ç¼–è¯‘ä¸º WASMï¼Œå¾®ä¿¡å°æ¸¸æˆåˆ™åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œé€‚é…ã€‚æ‰€æœ‰å¹³å°æœ€ç»ˆéƒ½é€šè¿‡æ’ä»¶èƒ¶æ°´å±‚ï¼ˆGlue Layerï¼‰è°ƒç”¨åŒä¸€å¥— C++ æ ¸å¿ƒä»£ç ï¼Œå®ç°äº†"ä¸€å¥—ä»£ç ï¼Œå¤šå¹³å°è¿è¡Œ"çš„ç›®æ ‡ã€‚

#### æ’ä»¶ç»“æ„è§£æ

æ’ä»¶ç›®å½•: `å·¥ç¨‹è·¯å¾„/native/plugins/xxxx`

```
MyFirstPlugin/
â”œâ”€â”€ cc_plugin.json          # æ’ä»¶é…ç½®æ–‡ä»¶
â”œâ”€â”€ include/                # å¤´æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ MyFirstPlugin.h     # ä¸»å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ IEventHandler.h     # äº‹ä»¶å¤„ç†æ¥å£
â”‚   â””â”€â”€ PluginPlus.h        # è·¨å¹³å°æŠ½è±¡å±‚
â”œâ”€â”€ src/                    # æºæ–‡ä»¶ç›®å½•
â”‚   â””â”€â”€ MyFirstPlugin.cpp   # ä¸»å®ç°æ–‡ä»¶
â”œâ”€â”€ glue/                   # èƒ¶æ°´ä»£ç ç›®å½•
â”‚   â””â”€â”€ MyFirstPlugin_glue.cpp
â”œâ”€â”€ d.ts/                   # TypeScriptå£°æ˜æ–‡ä»¶
â”‚   â””â”€â”€ MyFirstPlugin.d.ts
â”œâ”€â”€ android/                # Androidå¹³å°ä¾èµ–åº“å’Œcmakeé…ç½®æ–‡ä»¶
â”œâ”€â”€ ios/                    # iOSå¹³å°ä¾èµ–åº“å’Œcmakeé…ç½®æ–‡ä»¶
â”œâ”€â”€ web/                    # Webå¹³å°ä¾èµ–åº“å’Œcmakeé…ç½®æ–‡ä»¶,æ„å»ºè„šæœ¬
â””â”€â”€ wx/                     # å¾®ä¿¡å°æ¸¸æˆå¹³å°ä¾èµ–åº“å’Œcmakeé…ç½®æ–‡ä»¶,æ„å»ºè„šæœ¬
```


### 2. è·¨å¹³å°æ’ä»¶è®¾è®¡ä¸å®ç°

#### 2.1 æ’ä»¶æ¶æ„è®¾è®¡æ€è·¯

è·¨å¹³å°æ’ä»¶çš„æ ¸å¿ƒæŒ‘æˆ˜åœ¨äºï¼š**å¦‚ä½•ç”¨ä¸€å¥— C++ ä»£ç ï¼Œåœ¨ä¸åŒå¹³å°çš„ JavaScript ç»‘å®šæœºåˆ¶ä¸‹æ— ç¼è¿è¡Œ**ã€‚æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆé‡‡ç”¨äº†ä¸‰å±‚æ¶æ„ï¼š

1. **æ’ä»¶æ ¸å¿ƒå±‚**ï¼šç»Ÿä¸€çš„ C++ ä¸šåŠ¡é€»è¾‘ä»£ç ï¼ˆ`src/CC_PLUGIN_TP__.cpp`ï¼‰
2. **èƒ¶æ°´å±‚ï¼ˆGlue Layerï¼‰**ï¼šå¹³å°é€‚é…çš„ç»‘å®šç±»ï¼ˆ`glue/CC_PLUGIN_TP___glue.cpp`ï¼‰
3. **å¹³å°æŠ½è±¡å±‚**ï¼š`PluginPlus.h` æä¾›çš„ç»Ÿä¸€å®å®šä¹‰å’Œç±»å‹ç³»ç»Ÿ

**è®¾è®¡åŸåˆ™**ï¼š
- **æ ¸å¿ƒä»£ç é›¶å¹³å°ä¾èµ–**ï¼šä¸šåŠ¡é€»è¾‘å®Œå…¨ç‹¬ç«‹ï¼Œä¸åŒ…å«ä»»ä½•å¹³å°ç‰¹å®šä»£ç 
- **èƒ¶æ°´å±‚å¤„ç†å¹³å°å·®å¼‚**ï¼šé€šè¿‡ `PluginPlus.h` çš„å®å®šä¹‰è‡ªåŠ¨é€‚é…ä¸åŒå¹³å°
- **ç±»å‹ç³»ç»Ÿç»Ÿä¸€æŠ½è±¡**ï¼šä½¿ç”¨ `CCPObject`ã€`CCPInU8Arr`ã€`CCPOutU8Arr` ç­‰ç»Ÿä¸€ç±»å‹

#### 2.2 PluginPlus.hï¼šå¹³å°ä¸€è‡´æ€§çš„æ ¸å¿ƒ

`PluginPlus.h` æ˜¯æ•´ä¸ªè·¨å¹³å°æ–¹æ¡ˆçš„æ ¸å¿ƒï¼Œå®ƒé€šè¿‡æ¡ä»¶ç¼–è¯‘å’Œå®å®šä¹‰å®ç°äº†å®Œç¾çš„å¹³å°æŠ½è±¡ã€‚

##### 2.2.1 å¹³å°ç±»å‹ç³»ç»ŸæŠ½è±¡

```cpp
#ifdef CC_PLUGIN_WASM
    typedef emscripten::val CCPObject;          // Webå¹³å°ï¼šEmscriptençš„valç±»å‹
    typedef std::string CCPInU8Arr;            // Webå¹³å°ï¼šå­—ç¬¦ä¸²ä¼ é€’
#elif CC_PLUGIN_NATIVE
    typedef se::Object CCPObject;               // åŸç”Ÿå¹³å°ï¼šCocosçš„se::Object
    typedef std::vector<uint8_t> &CCPInU8Arr;   // åŸç”Ÿå¹³å°ï¼šå¼•ç”¨ä¼ é€’
#endif
```

**æŠ€æœ¯éš¾ç‚¹**ï¼šä¸åŒå¹³å°çš„ JavaScript ç»‘å®šç³»ç»Ÿä½¿ç”¨å®Œå…¨ä¸åŒçš„ç±»å‹ï¼š
- **Web å¹³å°**ï¼šEmscripten ä½¿ç”¨ `emscripten::val` è¡¨ç¤º JavaScript å¯¹è±¡
- **åŸç”Ÿå¹³å°**ï¼šCocos ä½¿ç”¨ `se::Object` è¡¨ç¤º JavaScript å¯¹è±¡

**è§£å†³æ–¹æ¡ˆ**ï¼šé€šè¿‡ `typedef` ç»Ÿä¸€ä¸º `CCPObject`ï¼Œä¸šåŠ¡ä»£ç æ— éœ€å…³å¿ƒåº•å±‚å®ç°ã€‚

##### 2.2.2 ç»Ÿä¸€çš„å±æ€§ç»‘å®šå®

```cpp
// å¼€å‘è€…åªéœ€è¦å†™ä¸€æ¬¡
CCPLUGINPROP(attrInt, int)

// Webå¹³å°è‡ªåŠ¨å±•å¼€ä¸ºï¼š
type attrInt;
emscripten::val getattrInt() const { return emscripten::val(attrInt); }
void setattrInt(emscripten::val value) { attrInt = value.as<type>(); }

// åŸç”Ÿå¹³å°è‡ªåŠ¨å±•å¼€ä¸ºï¼š
type attrInt;
type getattrInt() const { return attrInt; }
void setattrInt(const se::Value value) { attrInt = seval_to_type<type>(value, ok); }
```

**æŠ€æœ¯éš¾ç‚¹**ï¼šä¸åŒå¹³å°çš„å±æ€§è®¿é—®æ–¹å¼å®Œå…¨ä¸åŒï¼Œéœ€è¦ä¸åŒçš„ getter/setter å®ç°ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šé€šè¿‡å®å®šä¹‰è‡ªåŠ¨ç”Ÿæˆå¹³å°ç‰¹å®šçš„ä»£ç ï¼Œå¼€å‘è€…åªéœ€å£°æ˜å±æ€§å³å¯ã€‚

##### 2.2.3 ç»Ÿä¸€çš„å›è°ƒæœºåˆ¶

```cpp
// åœ¨ä¸šåŠ¡ä»£ç ä¸­ç»Ÿä¸€è°ƒç”¨ï¼ˆä½¿ç”¨ IEventHandler.h ä¸­å®šä¹‰çš„å¸¸é‡ï¼‰
CALL_JS(jsObject, ccp::PLUGIN_OPEN, (int)logLv, string("openPlugin"));

// Webå¹³å°å±•å¼€ä¸ºï¼š
jsObject->call<void>("onPluginOpen", logLv, "openPlugin");

// åŸç”Ÿå¹³å°å±•å¼€ä¸ºï¼š
se::Value func;
jsObject->getProperty("onPluginOpen", &func);
func.toObject()->call(args, jsObject);
```

**å›è°ƒå¸¸é‡å®šä¹‰**ï¼ˆåœ¨ `IEventHandler.h` ä¸­ï¼‰ï¼š

```cpp
namespace ccp {
    const std::string PLUGIN_OPEN = std::string("onPluginOpen");
    const std::string PLUGIN_CLOSE = std::string("onPluginClose");
    const std::string PLUGIN_ON_DATA = std::string("onPluginData");
    const std::string PLUGIN_ON_DATA_WITH_BUFFER = std::string("onPluginDataWithBuffer");
}
```

**æŠ€æœ¯éš¾ç‚¹**ï¼šWeb å¹³å°å¯ä»¥ç›´æ¥è°ƒç”¨ JavaScript å‡½æ•°ï¼ŒåŸç”Ÿå¹³å°éœ€è¦é€šè¿‡ `se::Object` çš„åå°„æœºåˆ¶ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š`CALL_JS` å®è‡ªåŠ¨å¤„ç†å¹³å°å·®å¼‚ï¼Œæä¾›ç»Ÿä¸€çš„è°ƒç”¨æ¥å£ã€‚

**å›è°ƒæ¥å£å®šä¹‰**ï¼š

æ’ä»¶å®šä¹‰äº† 4 ä¸ªå›è°ƒæ¥å£ï¼Œéœ€è¦åœ¨ TypeScript ä¸­å®ç°ï¼ˆé€šè¿‡ `IPluginDelegate` æ¥å£ï¼‰ï¼š

| å›è°ƒæ–¹æ³• | è§¦å‘æ—¶æœº | å‚æ•°è¯´æ˜ | ç¤ºä¾‹ |
|---------|---------|---------|------|
| `onPluginOpen(...data)` | æ’ä»¶æ‰“å¼€æ—¶ | `data[0]`: `number` (logLv), `data[1]`: `string` (message) | `onPluginOpen(1, "openPlugin")` |
| `onPluginClose(...data)` | æ’ä»¶å…³é—­æ—¶ | `data[0]`: `string` (message) | `onPluginClose("closePlugin")` |
| `onPluginData(...data)` | æ•°æ®å›è°ƒï¼ˆæŒ‡é’ˆæ–¹å¼ï¼‰ | `data[0]`: `number` (å†…å­˜æŒ‡é’ˆ), `data[1]`: `number` (å¤§å°) | `onPluginData(ptr, size)` |
| `onPluginDataWithBuffer(...data)` | æ•°æ®å›è°ƒï¼ˆç¼“å†²åŒºæ–¹å¼ï¼‰ | `data[0]`: `Uint8Array` (æ•°æ®ç¼“å†²åŒº), `data[1]`: `number` (å¤§å°) | `onPluginDataWithBuffer(buffer, size)` |

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```typescript
class PluginTest extends Component implements IPluginDelegate {
    plugin: COCOS_CC_PLUGIN_TP__;
    
    start() {
        // åˆ›å»ºæ’ä»¶å®ä¾‹ï¼Œä¼ å…¥ this ä½œä¸ºå›è°ƒå¯¹è±¡
        this.plugin = new COCOS_CC_PLUGIN_TP__(this);
        this.plugin.openPlugin(1);
    }
    
    // å®ç°å›è°ƒæ¥å£
    onPluginOpen(...data) {
        console.log('æ’ä»¶å·²æ‰“å¼€', data[0], data[1]); // logLv, message
    }
    
    onPluginClose(...data) {
        console.log('æ’ä»¶å·²å…³é—­', data[0]); // message
    }
    
    onPluginData(...data) {
        let ptr = data[0];      // å†…å­˜æŒ‡é’ˆ
        let size = data[1];     // æ•°æ®å¤§å°
        // é€šè¿‡ getBuffer è·å–æ•°æ®
        let buffer = this.plugin.getBuffer(ptr, size);
        // å¤„ç†æ•°æ®...
    }
    
    onPluginDataWithBuffer(...data) {
        let buffer = data[0];   // ç›´æ¥è·å– Uint8Array
        let size = data[1];     // æ•°æ®å¤§å°
        // ç›´æ¥ä½¿ç”¨ bufferï¼Œæ— éœ€è°ƒç”¨ getBuffer
        // å¤„ç†æ•°æ®...
    }
}
```

#### 2.3 èƒ¶æ°´å±‚å®ç°ç»†èŠ‚

èƒ¶æ°´å±‚ï¼ˆ`COCOS_CC_PLUGIN_TP__` ç±»ï¼‰æ˜¯è¿æ¥ JavaScript å’Œ C++ æ ¸å¿ƒä»£ç çš„æ¡¥æ¢ã€‚

##### 2.3.1 èƒ¶æ°´ç±»çš„èŒè´£

```cpp
class COCOS_CC_PLUGIN_TP__ {
    CCPObject *jsObject;                    // JavaScript å¯¹è±¡å¼•ç”¨
    CCPLUGINPROP(attrInt, int)              // å±æ€§ç»‘å®š
    ccp::CC_PLUGIN_TP__ *plugin = NULL;     // æ ¸å¿ƒä¸šåŠ¡å¯¹è±¡
    
    // ç”Ÿå‘½å‘¨æœŸç®¡ç†
    int openPlugin(int logLv);
    int closePlugin();
    
    // ä¸šåŠ¡æ–¹æ³•ä»£ç†
    std::string version();
    int sendData(CCPInU8Arr input, int size);
    CCPOutU8Arr generateImageData(int width, int height);
};
```

**å…³é”®è®¾è®¡**ï¼š
1. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼š`openPlugin` åˆ›å»ºæ ¸å¿ƒå¯¹è±¡ï¼Œ`closePlugin` é”€æ¯
2. **æ–¹æ³•ä»£ç†**ï¼šæ‰€æœ‰ä¸šåŠ¡æ–¹æ³•éƒ½é€šè¿‡èƒ¶æ°´ç±»è½¬å‘åˆ°æ ¸å¿ƒç±»
3. **ç±»å‹è½¬æ¢**ï¼šå¤„ç† JavaScript ç±»å‹å’Œ C++ ç±»å‹ä¹‹é—´çš„è½¬æ¢

##### 2.3.2 å¹³å°ç»‘å®šæ³¨å†Œ

**åŸç”Ÿå¹³å°ç»‘å®š**ï¼š
```cpp
CC_PLUGIN_BINDING_BEGIN(COCOS_CC_PLUGIN_TP__)
    .CCPLUGINPROPBIND(COCOS_CC_PLUGIN_TP__, attrInt)
    .CCPLUGINBIND(COCOS_CC_PLUGIN_TP__, openPlugin)
    .CCPLUGINBIND(COCOS_CC_PLUGIN_TP__, closePlugin)
    // ...
CC_PLUGIN_BINDING_END(COCOS_CC_PLUGIN_TP__)
```

å±•å¼€åé€šè¿‡ Cocos çš„ `sebind` ç³»ç»Ÿæ³¨å†Œåˆ° JavaScript è¿è¡Œæ—¶ï¼Œä½¿ç”¨ `CC_PLUGIN_ENTRY` å®è‡ªåŠ¨æ³¨å†Œã€‚

**Web å¹³å°ç»‘å®š**ï¼š
```cpp
EMSCRIPTEN_BINDINGS(COCOS_CC_PLUGIN_TP__) {
    emscripten::class_<COCOS_CC_PLUGIN_TP__>("COCOS_CC_PLUGIN_TP__")
        .constructor<emscripten::val>()
        .property("attrInt", &COCOS_CC_PLUGIN_TP__::getattrInt, &COCOS_CC_PLUGIN_TP__::setattrInt)
        .function("openPlugin", &COCOS_CC_PLUGIN_TP__::openPlugin)
        // ...
}
```

é€šè¿‡ Emscripten çš„ç»‘å®šç³»ç»Ÿå¯¼å‡ºåˆ° JavaScriptã€‚

#### 2.4 ç¬¬ä¸‰æ–¹åº“é›†æˆ

##### 2.4.1 CMake ä¾èµ–ç®¡ç†

åœ¨ `CMakeLists.txt` ä¸­é€šè¿‡ `include()` æœºåˆ¶ç®¡ç†ç¬¬ä¸‰æ–¹åº“ï¼š

```cmake
# æŸ¥æ‰¾ç¬¬ä¸‰æ–¹åº“ï¼ˆé€šè¿‡ include Config.cmake æ–‡ä»¶ï¼‰
include(${CMAKE_CURRENT_SOURCE_DIR}/android/simplelogConfig.cmake)
include(${CMAKE_CURRENT_SOURCE_DIR}/android/THREE_LIB_TP__Config.cmake)

# æˆ–è€…ç›´æ¥è®¾ç½®åº“è·¯å¾„ï¼ˆå®é™…å®ç°æ–¹å¼ï¼‰
set(COCOS_LIB_NAME "THREE_LIB_TP__")
add_library(${COCOS_LIB_NAME} STATIC IMPORTED GLOBAL)
set_target_properties(${COCOS_LIB_NAME} PROPERTIES
    INTERFACE_INCLUDE_DIRECTORIES "${PLUGIN_LIB_PATH}/include"
    IMPORTED_LOCATION "${PLUGIN_LIB_PATH}/lib/lib${COCOS_LIB_NAME}.a"
)

# é“¾æ¥åº“
target_link_libraries(${COCOS_PLUGIN_NAME} INTERFACE
    ${COCOS_LIB_NAME}
)
```

**æŠ€æœ¯è¦ç‚¹**ï¼š
- æ¯ä¸ªå¹³å°ç›®å½•ä¸‹æœ‰å¯¹åº”çš„ `*Config.cmake` æ–‡ä»¶
- é€šè¿‡ `PLUGIN_LIB_PATH` å˜é‡è‡ªåŠ¨å®šä½å¹³å°ç‰¹å®šçš„åº“æ–‡ä»¶
- åŸç”Ÿå¹³å°å’Œ Web å¹³å°ä½¿ç”¨ä¸åŒçš„åº“æ–‡ä»¶ï¼ˆ`.a` vs `.a`ï¼Œä½†ç¼–è¯‘é€‰é¡¹ä¸åŒï¼‰
- å®é™…å®ç°ä¸­é€šè¿‡ `include()` åŠ è½½ Config.cmake æ–‡ä»¶ï¼Œæˆ–ç›´æ¥ä½¿ç”¨ `add_library` è®¾ç½®åº“è·¯å¾„

##### 2.4.2 ç¬¬ä¸‰æ–¹åº“çš„è·¨å¹³å°ç¼–è¯‘

**å…³é”®é…ç½®**ï¼š
- **Android/iOS**ï¼šä½¿ç”¨ NDK/Xcode ç¼–è¯‘ä¸ºé™æ€åº“ï¼ˆ`.a`ï¼‰
- **Web**ï¼šä½¿ç”¨ Emscripten ç¼–è¯‘ä¸ºé™æ€åº“ï¼Œæœ€ç»ˆé“¾æ¥åˆ° WASM
- **å¾®ä¿¡å°æ¸¸æˆ**ï¼šä¸ Web ç›¸åŒï¼Œä½†éœ€è¦é¢å¤–çš„é€‚é…

**ç›®å½•ç»“æ„**ï¼š
```
android/
  â”œâ”€â”€ arm64-v8a/
  â”‚   â”œâ”€â”€ lib/libTHREE_LIB_TP__.a
  â”‚   â””â”€â”€ include/THREE_LIB_TP__.h
  â””â”€â”€ THREE_LIB_TP__Config.cmake
web/
  â”œâ”€â”€ lib/libTHREE_LIB_TP__.a  # Emscriptenç¼–è¯‘
  â””â”€â”€ include/THREE_LIB_TP__.h
```

#### 2.5 æ—¥å¿—å·¥å…·é›†æˆ

ä½¿ç”¨ `simplelog` ä½œä¸ºè·¨å¹³å°æ—¥å¿—å·¥å…·ï¼Œé€šè¿‡ `simple_log.h` æä¾›ç»Ÿä¸€æ¥å£ï¼š

```cpp
#include "simple_log.h"

simpleLog("CC_PLUGIN_TP__ version: %s", _version.c_str());
```

**ä¼˜åŠ¿**ï¼š
- ç»Ÿä¸€çš„æ—¥å¿—æ¥å£ï¼Œæ— éœ€å…³å¿ƒå¹³å°å·®å¼‚
- æ”¯æŒæ—¥å¿—çº§åˆ«æ§åˆ¶
- åœ¨ Web å¹³å°è¾“å‡ºåˆ°æµè§ˆå™¨æ§åˆ¶å°ï¼ŒåŸç”Ÿå¹³å°è¾“å‡ºåˆ°ç³»ç»Ÿæ—¥å¿—

### 3. å¹³å°ç»‘å®šä¸é›†æˆ

#### 3.1 åŸç”Ÿå¹³å°é›†æˆï¼ˆAndroid/iOSï¼‰

##### 3.1.1 æ’ä»¶é…ç½®

åœ¨ `cc_plugin.json` ä¸­å£°æ˜æ’ä»¶ï¼š

```json
{
    "name": "CC_PLUGIN_TP__",
    "version": "0.0.1",
    "engine-version": ">=3.6.0",
    "modules": [{
        "target": "COCOS_CC_PLUGIN_TP___glue",
        "depends": ["simplelog", "THREE_LIB_TP__"]
    }],
    "support-platforms": ["android", "ios"]
}
```

**å…³é”®ç‚¹**ï¼š
- `target` å¿…é¡»ä¸ `CC_PLUGIN_ENTRY` å®çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸€è‡´
- `depends` å£°æ˜ä¾èµ–çš„ç¬¬ä¸‰æ–¹åº“
- Cocos æ„å»ºç³»ç»Ÿä¼šè‡ªåŠ¨é€šè¿‡ CMake çš„ `include()` æˆ– `find_package` æœºåˆ¶æŸ¥æ‰¾åº“æ–‡ä»¶

##### 3.1.2 è‡ªåŠ¨é›†æˆæµç¨‹

**Android å’Œ iOS çš„é›†æˆéå¸¸ç®€å•**ï¼š

1. **æ”¾ç½®æ’ä»¶**ï¼šå°†æ’ä»¶ç›®å½•æ”¾åˆ° `native/plugins/` æˆ– `extensions/` ç›®å½•
2. **æ„å»ºé¡¹ç›®**ï¼šCocos Creator æ„å»ºæ—¶è‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æµç¨‹ï¼š
   - æ‰«æ `cc_plugin.json` æ–‡ä»¶
   - é€šè¿‡ CMake çš„ `include()` æˆ– `find_package` æœºåˆ¶æŸ¥æ‰¾ `COCOS_CC_PLUGIN_TP___glueConfig.cmake`
   - è‡ªåŠ¨é“¾æ¥åº“æ–‡ä»¶å’Œå¤´æ–‡ä»¶
   - é€šè¿‡ `sebind` ç³»ç»Ÿæ³¨å†Œåˆ° JavaScript è¿è¡Œæ—¶

**æ— éœ€æ‰‹åŠ¨é…ç½®**ï¼šCMake ä¼šè‡ªåŠ¨æ‰¾åˆ°å¯¹åº”å¹³å°çš„åº“æ–‡ä»¶ï¼ˆ`.so` æˆ– `.a`ï¼‰ï¼Œæ— éœ€åœ¨é¡¹ç›®è®¾ç½®ä¸­æ‰‹åŠ¨æ·»åŠ ã€‚

##### 3.1.3 TypeScript ç±»å‹å®šä¹‰

åœ¨ `d.ts/CC_PLUGIN_TP__.d.ts` ä¸­å®šä¹‰ TypeScript æ¥å£ï¼š

```typescript
declare class IPluginDelegate {
    constructor()
    onPluginOpen(...data)
    onPluginClose(...data)
    onPluginData(...data)
    onPluginDataWithBuffer(...data)
}

declare class COCOS_CC_PLUGIN_TP__ {
    attrInt: number
    constructor(delegate: IPluginDelegate)
    version(): string
    openPlugin(logLv: number): void
    closePlugin(): void
    sendData(data: Uint8Array, size: number): void
    getBuffer(val_ptr: number, size: number): Uint8Array
    generateImageData(width: number, height: number): Uint8Array
}
```

**ä½¿ç”¨æ–¹å¼**ï¼š
```typescript
// åŸç”Ÿå¹³å°ç›´æ¥ä½¿ç”¨
let plugin = new COCOS_CC_PLUGIN_TP__(this);

// æ‰“å¼€æ’ä»¶
plugin.openPlugin(1);
console.log(plugin.version());

// å‘é€æ•°æ®
let texData = new Uint8Array(500 * 500 * 4);
for (let i = 0; i < texData.length; i++) { 
    texData[i] = i % 255;
}
plugin.sendData(texData, texData.length);

// è·å–æ•°æ®ï¼ˆé€šè¿‡å›è°ƒ onPluginData æˆ– onPluginDataWithBufferï¼‰
// åœ¨å›è°ƒä¸­å¤„ç†æ•°æ®åï¼Œå¯ä»¥å…³é—­æ’ä»¶
plugin.closePlugin();
```

#### 3.2 Web å¹³å°é›†æˆ

##### 3.2.1 ç¼–è¯‘ WASM

ä½¿ç”¨ Emscripten ç¼–è¯‘ C++ ä»£ç ä¸º WASMï¼š

```bash
# åœ¨ web ç›®å½•ä¸‹æ‰§è¡Œ
cd web
./build_web.sh
```

**æ„å»ºè„šæœ¬å…³é”®æ­¥éª¤**ï¼ˆ`build_web.sh`ï¼‰ï¼š

1. **CMake é…ç½®**ï¼šä½¿ç”¨ `emcmake cmake` é…ç½®æ„å»º
2. **ç¼–è¯‘**ï¼šä½¿ç”¨ `emmake make` ç¼–è¯‘ï¼Œç”Ÿæˆ `.js` å’Œ `.wasm` æ–‡ä»¶
3. **WASM å†…åµŒ**ï¼šå°† WASM æ–‡ä»¶è½¬æ¢ä¸º base64 å­—ç¬¦ä¸²ï¼Œå†…åµŒåˆ° JS æ–‡ä»¶ä¸­
4. **æ¨¡å—å¯¼å‡º**ï¼šé€šè¿‡ `post.js` å°†æ¨¡å—å¯¼å‡ºä¸ºå…¨å±€å˜é‡

**å…³é”®æŠ€æœ¯ç‚¹**ï¼š
```bash
# å°† WASM è½¬ä¸º base64 å¹¶å†…åµŒ
filename="lib${projectName}.js"
base64 -i ${projectName}.wasm -o ${projectName}.base64
header='var RAWWasmBinaryFile = "data:application/octet-stream;base64,'
content=`cat ${projectName}.base64`
echo $header$content'";' > $filename
cat ${projectName}.js >> $filename

# æ›¿æ¢ wasm æ–‡ä»¶è·¯å¾„ä¸ºå†…åµŒçš„ base64
sed -i '' "s/\'${projectName}.wasm\'/RAWWasmBinaryFile/" $filename

# æ·»åŠ æ¨¡å—å¯¼å‡ºï¼ˆé€šè¿‡ post.jsï¼‰
a1=`cat ${workspace}/post/post.js`
echo $a1 >> $filename
```

**ä¸ºä»€ä¹ˆå†…åµŒ WASM**ï¼š
- é¿å…é¢å¤–çš„ç½‘ç»œè¯·æ±‚
- ç®€åŒ–éƒ¨ç½²æµç¨‹
- ç¡®ä¿ WASM æ–‡ä»¶ä¸ JS æ–‡ä»¶åŒæ­¥åŠ è½½

##### 3.2.2 é›†æˆåˆ° Cocos Creator

**ç†è§£æ„å»ºæ¨¡æ¿ç³»ç»Ÿ**ï¼š

Cocos Creator ä½¿ç”¨æ¨¡æ¿ç³»ç»Ÿæ¥ç”Ÿæˆæ„å»ºäº§ç‰©ï¼Œæ’ä»¶éœ€è¦é›†æˆåˆ°ä»¥ä¸‹æ¨¡æ¿ç›®å½•ï¼š

| æ¨¡æ¿ç›®å½• | ç”¨é€” | è¯´æ˜ |
|---------|------|------|
| `preview-template/` | ç¼–è¾‘å™¨é¢„è§ˆ | åœ¨ Cocos Creator ç¼–è¾‘å™¨ä¸­ç‚¹å‡»é¢„è§ˆæ—¶ä½¿ç”¨ |
| `build-templates/web-mobile/` | Web å¹³å°æ„å»º | æ„å»º Web å¹³å°é¡¹ç›®æ—¶ä½¿ç”¨ |
| `build-templates/wechatgame/` | å¾®ä¿¡å°æ¸¸æˆæ„å»º | æ„å»ºå¾®ä¿¡å°æ¸¸æˆé¡¹ç›®æ—¶ä½¿ç”¨ |

**ç›®å½•ç»“æ„**ï¼š

```
é¡¹ç›®æ ¹ç›®å½•/
â”œâ”€â”€ preview-template/              # é¢„è§ˆæ¨¡æ¿
â”‚   â”œâ”€â”€ ccplugins/                 # æ’ä»¶ç›®å½•
â”‚   â”‚   â””â”€â”€ libCC_PLUGIN_TP__.js  # Web å¹³å°æ’ä»¶æ–‡ä»¶
â”‚   â””â”€â”€ index.ejs                  # é¢„è§ˆé¡µé¢æ¨¡æ¿
â”‚
â””â”€â”€ build-templates/               # æ„å»ºæ¨¡æ¿
    â”œâ”€â”€ web-mobile/                # Web å¹³å°æ¨¡æ¿
    â”‚   â”œâ”€â”€ ccplugins/
    â”‚   â”‚   â””â”€â”€ libCC_PLUGIN_TP__.js
    â”‚   â””â”€â”€ index.ejs
    â”‚
    â””â”€â”€ wechatgame/                # å¾®ä¿¡å°æ¸¸æˆæ¨¡æ¿
        â”œâ”€â”€ ccplugins/
        â”‚   â”œâ”€â”€ CC_PLUGIN_TP__.js
        â”‚   â””â”€â”€ CC_PLUGIN_TP__.wasm
        â””â”€â”€ game.ejs
```

**æ­¥éª¤ 1ï¼šå¤åˆ¶æ–‡ä»¶åˆ°æ„å»ºæ¨¡æ¿**

å°†ç¼–è¯‘ç”Ÿæˆçš„ WASM æ–‡ä»¶å¤åˆ¶åˆ°å¯¹åº”çš„æ¨¡æ¿ç›®å½•ï¼š

**Web å¹³å°**ï¼š
- `build-templates/web-mobile/ccplugins/libCC_PLUGIN_TP__.js`
- `preview-template/ccplugins/libCC_PLUGIN_TP__.js`

**å¾®ä¿¡å°æ¸¸æˆ**ï¼š
- `build-templates/wechatgame/ccplugins/CC_PLUGIN_TP__.js`
- `build-templates/wechatgame/ccplugins/CC_PLUGIN_TP__.wasm`

**æ­¥éª¤ 2ï¼šåœ¨æ¨¡æ¿æ–‡ä»¶ä¸­åŠ è½½æ’ä»¶**

**Web å¹³å°**ï¼ˆ`index.ejs`ï¼‰ï¼š

åœ¨ `preview-template/index.ejs` å’Œ `build-templates/web-mobile/index.ejs` ä¸­æ·»åŠ ï¼š

```html
<!-- åœ¨ <body> æ ‡ç­¾å†…ï¼Œå¼•æ“è„šæœ¬ä¹‹å‰æ·»åŠ  -->
<script src="ccplugins/libCC_PLUGIN_TP__.js" charset="utf-8"></script>
```

**å¾®ä¿¡å°æ¸¸æˆ**ï¼ˆ`game.ejs`ï¼‰ï¼š

åœ¨ `build-templates/wechatgame/game.ejs` ä¸­æ·»åŠ ï¼š

```javascript
// åœ¨ __initApp å‡½æ•°ä¸­ï¼Œå¼•æ“åŠ è½½ä¹‹å‰æ·»åŠ 
require("./ccplugins/CC_PLUGIN_TP__.js");
```

**æ³¨æ„äº‹é¡¹**ï¼š
- **é¢„è§ˆæ¨¡æ¿**ï¼šå¿…é¡»é…ç½®ï¼Œå¦åˆ™ç¼–è¾‘å™¨é¢„è§ˆæ—¶æ— æ³•ä½¿ç”¨æ’ä»¶
- **æ„å»ºæ¨¡æ¿**ï¼šå¿…é¡»é…ç½®ï¼Œå¦åˆ™æ„å»ºåçš„é¡¹ç›®æ— æ³•ä½¿ç”¨æ’ä»¶
- **åŠ è½½é¡ºåº**ï¼šæ’ä»¶è„šæœ¬å¿…é¡»åœ¨å¼•æ“è„šæœ¬ä¹‹å‰åŠ è½½ï¼Œç¡®ä¿æ’ä»¶åœ¨æ¸¸æˆä»£ç æ‰§è¡Œå‰åˆå§‹åŒ–
- **æ–‡ä»¶è·¯å¾„**ï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„ `ccplugins/`ï¼ŒCocos Creator ä¼šè‡ªåŠ¨å¤„ç†è·¯å¾„è½¬æ¢

**æ­¥éª¤ 3ï¼šåœ¨ TypeScript ä¸­ä½¿ç”¨**

```typescript
// è·å– WASM æ¨¡å—ï¼ˆä½¿ç”¨ @ts-ignore å¿½ç•¥ç±»å‹æ£€æŸ¥ï¼‰
//@ts-ignore
let WASM = window.COCOS_CC_PLUGIN_TP__;

// åˆ›å»ºæ’ä»¶å®ä¾‹
let plugin = new WASM.COCOS_CC_PLUGIN_TP__(this);

// æ‰“å¼€æ’ä»¶
plugin.openPlugin(1);
console.log(plugin.version());

// å‘é€æ•°æ®
let texData = new Uint8Array(500 * 500 * 4);
for (let i = 0; i < texData.length; i++) { 
    texData[i] = i % 255;
}
plugin.sendData(texData, texData.length);

// è·å–æ•°æ®ï¼ˆé€šè¿‡å›è°ƒ onPluginData æˆ– onPluginDataWithBufferï¼‰
// åœ¨å›è°ƒä¸­å¤„ç†æ•°æ®åï¼Œå¯ä»¥å…³é—­æ’ä»¶
plugin.closePlugin();
```

##### 3.2.3 è°ƒç”¨ WASM ä¸­çš„ C++ ä»£ç 

**å…³é”®ä»£ç ç¤ºä¾‹**ï¼ˆ`PluginTest.ts`ï¼‰ï¼š

```typescript
// å¹³å°æ£€æµ‹
let plugin = sys.isNative 
    ? new COCOS_CC_PLUGIN_TP__(this)      // åŸç”Ÿå¹³å°
    : new WASM.COCOS_CC_PLUGIN_TP__(this); // Webå¹³å°

// ç»Ÿä¸€æ¥å£è°ƒç”¨
plugin.openPlugin(1);
plugin.sendData(this.texData, this.texData.length);

// å›è°ƒå¤„ç†
onPluginData(...data) {
    let ptr = data[0];      // WASM å†…å­˜æŒ‡é’ˆ
    let size = data[1];
    let outArray = plugin.getBuffer(ptr, size); // è·å– TypedArray
    this.texData = outArray;
}
```

**æŠ€æœ¯éš¾ç‚¹**ï¼š
1. **å†…å­˜ç®¡ç†**ï¼šWASM å’Œ JavaScript å…±äº«çº¿æ€§å†…å­˜ï¼Œéœ€è¦æ­£ç¡®ä¼ é€’æŒ‡é’ˆ
2. **ç±»å‹è½¬æ¢**ï¼š`Uint8Array` ä¸ C++ çš„ `uint8_t*` ä¹‹é—´çš„è½¬æ¢
3. **å›è°ƒæœºåˆ¶**ï¼šC++ è°ƒç”¨ JavaScript å›è°ƒå‡½æ•°

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ `CCP_UINT8ARRAY` å®è‡ªåŠ¨å¤„ç†ç±»å‹è½¬æ¢
- é€šè¿‡ `CALL_JS` å®ç»Ÿä¸€å›è°ƒè°ƒç”¨
- ä½¿ç”¨ `emscripten::typed_memory_view` åˆ›å»º JavaScript å¯è®¿é—®çš„å†…å­˜è§†å›¾

**èƒ¶æ°´å±‚æ”¯æŒçš„æ•°æ®ç±»å‹**ï¼š

PluginPlus.h å®šä¹‰äº† 4 ç§å¹³å°æŠ½è±¡ç±»å‹ï¼Œç”¨äºç»Ÿä¸€ä¸åŒå¹³å°çš„ç±»å‹å·®å¼‚ï¼š

| C++ æŠ½è±¡ç±»å‹ | Web å¹³å°å®ç° | åŸç”Ÿå¹³å°å®ç° | JavaScript ç±»å‹ | ä½¿ç”¨åœºæ™¯ |
|------------|------------|------------|----------------|---------|
| `CCPObject` | `emscripten::val` | `se::Object` | `Object` | JavaScript å¯¹è±¡å¼•ç”¨ï¼Œæ„é€ å‡½æ•°å‚æ•°ã€å›è°ƒå¯¹è±¡ |
| `CCPInU8Arr` | `std::string` | `std::vector<uint8_t> &` | `Uint8Array` | è¾“å…¥å­—èŠ‚æ•°ç»„ï¼Œå‡½æ•°å‚æ•° |
| `CCPOutU8Arr` | `emscripten::val` | `se::Object *` | `Uint8Array` | è¾“å‡ºå­—èŠ‚æ•°ç»„ï¼Œå‡½æ•°è¿”å›å€¼ |
| `uCCPrt` | `u32` | `uint64_t` | `number` | å†…å­˜æŒ‡é’ˆï¼Œä¼ é€’ C++ å†…å­˜åœ°å€ |

**åŸºæœ¬ç±»å‹æ”¯æŒ**ï¼š

é™¤äº†ä¸Šè¿° 4 ç§å¹³å°æŠ½è±¡ç±»å‹å¤–ï¼Œèƒ¶æ°´å±‚è¿˜åŸç”Ÿæ”¯æŒä»¥ä¸‹åŸºæœ¬ç±»å‹ï¼ˆæ— éœ€å¹³å°æŠ½è±¡ï¼‰ï¼š
- `int` / `u32` / `u8` â†” `number`
- `std::string` â†” `string`
- `bool` â†” `boolean`
- `float` / `double` â†” `number`

**ç±»å‹ä½¿ç”¨ç¤ºä¾‹**ï¼š

```cpp
// åŸºæœ¬ç±»å‹
int openPlugin(int logLv);                    // int â†” number
std::string version();                        // string â†” string

// æ•°ç»„ç±»å‹
int sendData(CCPInU8Arr input, int size);     // Uint8Array â†’ C++ æ•°ç»„
CCPOutU8Arr generateImageData(int w, int h); // C++ æ•°ç»„ â†’ Uint8Array

// æŒ‡é’ˆç±»å‹
CCPOutU8Arr getBuffer(uCCPrt ptr_val, u32 size); // number(æŒ‡é’ˆ) â†’ Uint8Array

// å›è°ƒä¸­çš„ç±»å‹ï¼ˆä½¿ç”¨ IEventHandler.h ä¸­å®šä¹‰çš„å¸¸é‡ï¼‰
CALL_JS(jsObject, ccp::PLUGIN_ON_DATA, (uCCPrt)ptr_val, (u32)size);
CALL_JS(jsObject, ccp::PLUGIN_ON_DATA_WITH_BUFFER, buffer, (u32)size);
// æ”¯æŒä¼ é€’ï¼šint, string, u32, uCCPrt, CCPOutU8Arr ç­‰å¤šç§ç±»å‹
```

**æ³¨æ„äº‹é¡¹**ï¼š
- **æŒ‡é’ˆä¼ é€’**ï¼šWeb å¹³å°ä½¿ç”¨ 32 ä½æŒ‡é’ˆï¼ˆ`u32`ï¼‰ï¼ŒåŸç”Ÿå¹³å°ä½¿ç”¨ 64 ä½æŒ‡é’ˆï¼ˆ`uint64_t`ï¼‰ï¼Œé€šè¿‡ `uCCPrt` ç»Ÿä¸€æŠ½è±¡
- **æ•°ç»„ä¼ é€’**ï¼šè¾“å…¥æ•°ç»„åœ¨ Web å¹³å°é€šè¿‡å­—ç¬¦ä¸²ä¼ é€’ï¼ŒåŸç”Ÿå¹³å°é€šè¿‡å¼•ç”¨ä¼ é€’ï¼Œä½†æ¥å£ç»Ÿä¸€ä¸º `CCPInU8Arr`
- **å›è°ƒå‚æ•°**ï¼š`CALL_JS` å®æ”¯æŒå¯å˜å‚æ•°ï¼Œå¯ä»¥ä¼ é€’å¤šç§ç±»å‹çš„ç»„åˆ

#### 3.3 å¾®ä¿¡å°æ¸¸æˆé›†æˆ

å¾®ä¿¡å°æ¸¸æˆçš„é›†æˆæ–¹å¼ä¸ Web å¹³å°ç±»ä¼¼ï¼Œä½†æœ‰ä¸€äº›ç‰¹æ®Šå¤„ç†ï¼š

##### 3.3.1 æ„å»ºé…ç½®

å¾®ä¿¡å°æ¸¸æˆä½¿ç”¨ä¸ Web ç›¸åŒçš„ Emscripten ç¼–è¯‘æµç¨‹ï¼Œä½†éœ€è¦ï¼š
1. **æ–‡ä»¶æ ¼å¼**ï¼šç”Ÿæˆ `.wasm` å’Œ `.js` æ–‡ä»¶
2. **æ¨¡å—å¯¼å‡º**ï¼šä½¿ç”¨ `post.mjs` å¯¼å‡ºä¸º ES6 æ¨¡å—ï¼ˆå¦‚æœæ”¯æŒï¼‰
3. **æ–‡ä»¶ç³»ç»Ÿé€‚é…**ï¼šå¾®ä¿¡å°æ¸¸æˆçš„æ–‡ä»¶ç³»ç»Ÿé™åˆ¶éœ€è¦ç‰¹æ®Šå¤„ç†

##### 3.3.2 é›†æˆåˆ°å¾®ä¿¡å°æ¸¸æˆ

**æ­¥éª¤ 1ï¼šå¤åˆ¶æ–‡ä»¶åˆ°æ„å»ºæ¨¡æ¿**

å°†ç¼–è¯‘äº§ç‰©å¤åˆ¶åˆ°ï¼š
- `build-templates/wechatgame/ccplugins/CC_PLUGIN_TP__.js`
- `build-templates/wechatgame/ccplugins/CC_PLUGIN_TP__.wasm`

**æ³¨æ„**ï¼šå¾®ä¿¡å°æ¸¸æˆä¸éœ€è¦ `preview-template`ï¼Œå› ä¸ºå¾®ä¿¡å°æ¸¸æˆæ— æ³•åœ¨ç¼–è¾‘å™¨ä¸­é¢„è§ˆã€‚

**æ­¥éª¤ 2ï¼šåœ¨ game.ejs ä¸­åŠ è½½**

åœ¨ `build-templates/wechatgame/game.ejs` çš„ `__initApp` å‡½æ•°ä¸­ï¼Œå¼•æ“åŠ è½½ä¹‹å‰æ·»åŠ ï¼š

```javascript
function __initApp () {
    globalThis.__wxRequire = require;
    require('./web-adapter');
    const firstScreen = require('./first-screen');
    
    // åŠ è½½æ’ä»¶ï¼ˆåœ¨å¼•æ“åŠ è½½ä¹‹å‰ï¼‰
    require("./ccplugins/CC_PLUGIN_TP__.js");
    
    // ... å…¶ä»–ä»£ç 
}
```

**å…³é”®ç‚¹**ï¼š
- ä½¿ç”¨ `require()` è€Œä¸æ˜¯ `<script>` æ ‡ç­¾ï¼Œå› ä¸ºå¾®ä¿¡å°æ¸¸æˆä½¿ç”¨ CommonJS æ¨¡å—ç³»ç»Ÿ
- å¿…é¡»åœ¨å¼•æ“è„šæœ¬åŠ è½½ä¹‹å‰åŠ è½½æ’ä»¶
- æ–‡ä»¶è·¯å¾„ä½¿ç”¨ç›¸å¯¹è·¯å¾„ `./ccplugins/`

**æ­¥éª¤ 3ï¼šä½¿ç”¨æ–¹å¼**

ä¸ Web å¹³å°å®Œå…¨ç›¸åŒï¼Œé€šè¿‡ `WASM.COCOS_CC_PLUGIN_TP__` è®¿é—®ï¼š

```typescript
//@ts-ignore
let WASM = window.COCOS_CC_PLUGIN_TP__;
let plugin = new WASM.COCOS_CC_PLUGIN_TP__(this);
plugin.openPlugin(1);
```

**æ³¨æ„äº‹é¡¹**ï¼š
- å¾®ä¿¡å°æ¸¸æˆå¯¹åŒ…ä½“å¤§å°æœ‰ä¸¥æ ¼é™åˆ¶ï¼Œéœ€è¦ä¼˜åŒ– WASM ä½“ç§¯
- æŸäº›å¾®ä¿¡ API å¯èƒ½éœ€è¦ç‰¹æ®Šé€‚é…
- æ–‡ä»¶ç³»ç»Ÿè®¿é—®å—é™ï¼Œéœ€è¦æå‰è§„åˆ’èµ„æºåŠ è½½æ–¹å¼  

### 4. æœªå®ç°çš„åŠŸèƒ½

- Webå’Œå¾®ä¿¡å°æ¸¸æˆä¸æ”¯æŒåŠ¨æ€åŠ è½½wasm,æ‰€ä»¥éœ€è¦æ‰“åŒ…åˆ°é¡¹ç›®ä¸­,å¯ä»¥å‚è€ƒcocoså†…éƒ¨wasmçš„åŠ¨æ€åŠ è½½æµç¨‹è¿›è¡Œä¿®æ”¹,æœ¬æ–‡åªæ˜¯ä»‹ç»æ•´ä½“æµç¨‹,å…·ä½“ä¼˜åŒ–åç»­å¯ä»¥ç»§ç»­æ¢ç´¢

- åŸç”Ÿæ’ä»¶ä¸æ”¯æŒandroidå’Œiosçš„uiç•Œé¢,éœ€è¦å®˜æ–¹è¿›ä¸€æ­¥æ”¯æŒoc/javaç­‰åŸç”Ÿuiçš„æ–¹ä¾¿é›†æˆ,ä¸ºåç»­å„ç§sdkçš„æ¥å…¥æä¾›æ›´ä¾¿åˆ©çš„é›†æˆæ–¹å¼
- å¤šæ’ä»¶æ•´åˆç¼–è¯‘ä¸æ”¯æŒ,ç›®å‰åªèƒ½ä¸€ä¸ªæ’ä»¶ä¸€ä¸ªwasm,å¦‚æœè¦å¤šä¸ªæ’ä»¶æ•´åˆåˆ°ä¸€èµ·,å‡å°åŒ…ä½“,éœ€è¦è‡ªå·±æ”¹é€ 

### 5. ç»“æŸè¯­

å¥½äº†,ä½ å¯ä»¥å»æŠŠC++æ¬åˆ°å•†åº—äº†,æ— éœ€æ”¹å¼•æ“,æŠŠC++çš„å¼ºå¤§å¡«æ»¡æ•´ä¸ªStore,ç¥å¤§å®¶èµšé’±å¤šå¤š,Cocosçš„ç”Ÿæ€æ›´åŠ çš„å¼ºå¤§!
å¦‚æœä¸ä¼šcmake,AIä¼šå¸®ä½ ,AIæ—¶ä»£å­¦ä¹ C++éš¾åº¦ç›´çº¿é™ä½.

æºç åœ°å€: [https://github.com/xiongxinwei](https://github.com/xiongxinwei)